<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PantelMed AI - Діагностика здоров'я</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background-color: var(--tg-theme-bg-color, #1a1a1a);
            color: var(--tg-theme-text-color, #ffffff);
            line-height: 1.4;
            font-size: 16px;
        }

        .app {
            max-width: 400px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
        }

        .hidden {
            display: none;
        }

        /* Кнопка назад */
        .back-button {
            position: fixed;
            top: 20px;
            left: 20px;
            width: 40px;
            height: 40px;
            background-color: var(--tg-theme-button-color, #0088cc);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .back-button:hover {
            background-color: #0077bb;
            transform: scale(1.1);
        }

        .back-button.hidden {
            display: none;
        }

        /* Головне меню */
        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 8px;
            background: linear-gradient(45deg, #0088cc, #0099ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header p {
            color: var(--tg-theme-hint-color, #999);
            font-size: 14px;
        }

        .menu-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .menu-item {
            background-color: var(--tg-theme-secondary-bg-color, #2d2d2d);
            padding: 20px 15px;
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .menu-item:hover {
            background-color: var(--tg-theme-button-color, #0088cc);
            transform: translateY(-2px);
        }

        .menu-item.disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .menu-icon {
            font-size: 32px;
            display: block;
            margin-bottom: 8px;
        }

        .menu-title {
            font-size: 13px;
            font-weight: 600;
        }

        .coming-soon {
            font-size: 10px;
            color: var(--tg-theme-hint-color, #999);
            display: block;
            margin-top: 4px;
        }

        /* Форма профілю */
        .profile-form {
            background-color: var(--tg-theme-secondary-bg-color, #2d2d2d);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--tg-theme-text-color, #ffffff);
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--tg-theme-button-color, #0088cc);
            border-radius: 8px;
            background-color: var(--tg-theme-bg-color, #1a1a1a);
            color: var(--tg-theme-text-color, #ffffff);
            font-size: 16px;
        }

        /* Тест */
        .progress-bar {
            background-color: var(--tg-theme-secondary-bg-color, #2d2d2d);
            height: 8px;
            border-radius: 4px;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .progress-fill {
            background: linear-gradient(90deg, #4caf50, #8bc34a);
            height: 100%;
            transition: width 0.3s ease;
        }

        .progress-text {
            text-align: center;
            margin-bottom: 10px;
            font-size: 14px;
            color: var(--tg-theme-hint-color, #999);
        }

        .block-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .block-title {
            font-size: 20px;
            margin-bottom: 8px;
        }

        .block-description {
            color: var(--tg-theme-hint-color, #999);
            font-size: 14px;
        }

        .question-block {
            background-color: var(--tg-theme-secondary-bg-color, #2d2d2d);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .question-counter {
            background-color: var(--tg-theme-button-color, #0088cc);
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            display: inline-block;
            margin-bottom: 15px;
        }

        .question-text {
            font-size: 16px;
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .answer-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .answer-button {
            background-color: var(--tg-theme-bg-color, #1a1a1a);
            border: 2px solid var(--tg-theme-button-color, #0088cc);
            color: var(--tg-theme-text-color, #ffffff);
            padding: 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
        }

        .answer-button:hover {
            background-color: var(--tg-theme-button-color, #0088cc);
        }

        .answer-button.selected {
            background-color: var(--tg-theme-button-color, #0088cc);
            border-color: #4caf50;
        }

        .checkbox-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background-color: var(--tg-theme-bg-color, #1a1a1a);
            border-radius: 8px;
            cursor: pointer;
        }

        .checkbox-option input[type="checkbox"] {
            width: 18px;
            height: 18px;
        }

        /* Кнопки */
        .continue-button {
            width: 100%;
            background: linear-gradient(45deg, #4caf50, #45a049);
            color: white;
            border: none;
            padding: 16px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
        }

        .continue-button:hover {
            transform: translateY(-2px);
        }

        .continue-button:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }

        .secondary-button {
            background-color: var(--tg-theme-secondary-bg-color, #2d2d2d);
            color: var(--tg-theme-text-color, #ffffff);
            border: 1px solid var(--tg-theme-button-color, #0088cc);
        }

        .back-to-menu {
            width: 100%;
            background-color: var(--tg-theme-secondary-bg-color, #2d2d2d);
            color: var(--tg-theme-text-color, #ffffff);
            border: 1px solid var(--tg-theme-button-color, #0088cc);
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 20px;
        }

        /* Результати */
        .results-container {
            margin-bottom: 30px;
        }

        .user-info {
            background-color: var(--tg-theme-secondary-bg-color, #2d2d2d);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            text-align: center;
        }

        .dominant-card {
            background: linear-gradient(135deg, #4caf50, #45a049);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            margin-bottom: 20px;
        }

        .dominant-emoji {
            font-size: 48px;
            display: block;
            margin-bottom: 10px;
        }

        .score-bar {
            background-color: rgba(255, 255, 255, 0.3);
            height: 8px;
            border-radius: 4px;
            margin: 15px 0;
            overflow: hidden;
        }

        .score-fill {
            height: 100%;
            background-color: white;
            transition: width 0.3s ease;
        }

        .score-fill.good {
            background-color: #4caf50;
        }

        .score-fill.warning {
            background-color: #ff9800;
        }

        .score-fill.danger {
            background-color: #f44336;
        }

        .percentage {
            font-size: 24px;
            font-weight: bold;
        }

        .result-category {
            margin-bottom: 30px;
        }

        .result-category h4 {
            color: var(--tg-theme-button-color, #0088cc);
            margin-bottom: 15px;
            font-size: 18px;
        }

        .result-item {
            background-color: var(--tg-theme-secondary-bg-color, #2d2d2d);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .result-name {
            font-weight: 600;
        }

        .result-percentage {
            font-weight: bold;
            padding: 4px 8px;
            border-radius: 4px;
        }

        .result-percentage.good {
            background-color: #4caf50;
            color: white;
        }

        .result-percentage.warning {
            background-color: #ff9800;
            color: white;
        }

        .result-percentage.danger {
            background-color: #f44336;
            color: white;
        }

        .score-bar-small {
            background-color: var(--tg-theme-bg-color, #1a1a1a);
            height: 6px;
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        /* Selling texts */
        .selling-text {
            background-color: var(--tg-theme-bg-color, #1a1a1a);
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
            border-left: 4px solid #ff6b6b;
        }

        .selling-text h5 {
            color: #ff6b6b;
            margin: 0 0 10px 0;
            font-size: 14px;
        }

        .selling-text p {
            margin: 0 0 10px 0;
            font-size: 13px;
            line-height: 1.4;
            color: var(--tg-theme-text-color, #ffffff);
        }

        .basic-practices {
            margin: 10px 0;
        }

        .basic-practices strong {
            display: block;
            margin-bottom: 5px;
            color: var(--tg-theme-text-color, #ffffff);
            font-size: 12px;
        }

        .basic-practices ul {
            margin: 0;
            padding-left: 15px;
            color: var(--tg-theme-hint-color, #999);
        }

        .basic-practices li {
            margin-bottom: 3px;
            font-size: 12px;
        }

        .upgrade-cta {
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            text-align: center;
        }

        .upgrade-cta p {
            color: white;
            margin: 0 0 10px 0;
            font-size: 14px;
        }

        .upgrade-cta-btn {
            background: linear-gradient(45deg, #ff6b6b, #ee5a52);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            font-weight: 600;
        }

        /* Processing animation */
        .processing-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .processing-overlay.visible {
            opacity: 1;
        }

        .processing-card {
            background-color: var(--tg-theme-secondary-bg-color, #2d2d2d);
            padding: 30px;
            border-radius: 16px;
            text-align: center;
            max-width: 300px;
        }

        .processing-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--tg-theme-button-color, #0088cc);
            border-top: 4px solid transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .processing-text {
            font-size: 16px;
            margin-bottom: 15px;
            color: var(--tg-theme-text-color, #ffffff);
        }

        .processing-dots {
            display: flex;
            justify-content: center;
            gap: 5px;
        }

        .processing-dots span {
            width: 8px;
            height: 8px;
            background-color: var(--tg-theme-button-color, #0088cc);
            border-radius: 50%;
            animation: bounce 1.4s ease-in-out infinite both;
        }

        .processing-dots span:nth-child(1) { animation-delay: -0.32s; }
        .processing-dots span:nth-child(2) { animation-delay: -0.16s; }

        @keyframes bounce {
            0%, 80%, 100% { 
                transform: scale(0);
            } 40% { 
                transform: scale(1);
            }
        }

        /* Дієти */
        .diet-menu {
            background-color: var(--tg-theme-secondary-bg-color, #2d2d2d);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .diet-card {
            background-color: var(--tg-theme-bg-color, #1a1a1a);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #4caf50;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .diet-card:hover {
            transform: translateX(5px);
            border-left-color: #2196f3;
        }

        .diet-card h4 {
            margin: 0 0 8px 0;
            color: var(--tg-theme-text-color, #ffffff);
            font-size: 16px;
        }

        .diet-card p {
            margin: 0 0 10px 0;
            color: var(--tg-theme-hint-color, #999);
            font-size: 14px;
        }

        .diet-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }

        .diet-tag {
            background-color: var(--tg-theme-button-color, #0088cc);
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
        }

        .diet-card.featured {
            border-left-color: #ff6b6b;
            background: linear-gradient(135deg, rgba(255, 107, 107, 0.1), rgba(238, 90, 82, 0.05));
        }

        /* Курси */
        .course-grid {
            display: grid;
            gap: 15px;
            margin: 20px 0;
        }

        .course-card {
            background-color: var(--tg-theme-secondary-bg-color, #2d2d2d);
            padding: 20px;
            border-radius: 12px;
            border-left: 4px solid #ff9800;
        }

        .course-card h4 {
            color: #ff9800;
            margin-bottom: 10px;
        }

        .course-card ul {
            padding-left: 20px;
            margin-bottom: 15px;
        }

        .course-card li {
            margin-bottom: 5px;
            font-size: 14px;
        }

        .course-price {
            font-weight: bold;
            color: #4caf50;
            font-size: 18px;
        }

        /* Responsive */
        @media (max-width: 480px) {
            .app {
                padding: 10px;
            }
            
            .menu-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .answer-options {
                flex-direction: column;
            }
            
            .answer-button {
                min-width: auto;
            }

            .back-button {
                top: 10px;
                left: 10px;
                width: 35px;
                height: 35px;
                font-size: 16px;
            }
        }
    </style>
</head>
<body>
    <div class="app">
        <!-- Кнопка назад -->
        <button id="backButton" class="back-button hidden" onclick="goBack()">
            ←
        </button>

        <!-- Головне меню -->
        <div id="menu-screen" class="screen">
            <div class="header">
                <h1>🧬 PantelMed AI</h1>
                <p>Розумна медична платформа в Telegram</p>
            </div>

            <div class="menu-grid">
                <div class="menu-item" onclick="handleMenuClick('test')">
                    <span class="menu-icon">🧬</span>
                    <span class="menu-title">Пройти тест</span>
                </div>

                <div class="menu-item" onclick="handleMenuClick('cabinet')">
                    <span class="menu-icon">👤</span>
                    <span class="menu-title">Мій кабінет</span>
                </div>

                <div class="menu-item" onclick="handleMenuClick('diet')">
                    <span class="menu-icon">🥗</span>
                    <span class="menu-title">Персональна дієта</span>
                </div>

                <div class="menu-item" onclick="handleMenuClick('pharma')">
                    <span class="menu-icon">💊💉</span>
                    <span class="menu-title">Фармакологія</span>
                </div>

                <div class="menu-item" onclick="handleMenuClick('consultation')">
                    <span class="menu-icon">👨‍⚕️</span>
                    <span class="menu-title">Консультація</span>
                </div>

                <div class="menu-item" onclick="handleMenuClick('interpretation')">
                    <span class="menu-icon">📊</span>
                    <span class="menu-title">Інтерпретація аналізів</span>
                </div>
            </div>
        </div>

        <!-- Екран профілю -->
        <div id="profile-screen" class="screen hidden">
            <div class="header">
                <h2>👤 Персональні дані</h2>
                <p>Для точної діагностики потрібні ваші дані</p>
            </div>

            <div class="profile-form">
                <div class="form-group">
                    <label for="userName">Ім'я:</label>
                    <input type="text" id="userName" placeholder="Введіть ваше ім'я">
                </div>

                <div class="form-group">
                    <label for="userAge">Вік:</label>
                    <select id="userAge">
                        <option value="">Оберіть вік</option>
                        <option value="18-25">18-25 років</option>
                        <option value="26-35">26-35 років</option>
                        <option value="36-45">36-45 років</option>
                        <option value="46-55">46-55 років</option>
                        <option value="56+">56+ років</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="userGender">Стать:</label>
                    <select id="userGender">
                        <option value="">Оберіть стать</option>
                        <option value="male">Чоловік</option>
                        <option value="female">Жінка</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="userBodyType">Статура:</label>
                    <select id="userBodyType">
                        <option value="">Оберіть статуру</option>
                        <option value="thin">Худа</option>
                        <option value="normal">Нормальна</option>
                        <option value="athletic">Спортивна</option>
                        <option value="overweight">Повна</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="userHeight">Зріст (см):</label>
                    <input type="number" id="userHeight" placeholder="170" min="100" max="250">
                </div>

                <div class="form-group">
                    <label for="userWeight">Вага (кг):</label>
                    <input type="number" id="userWeight" placeholder="70" min="30" max="200">
                </div>
            </div>

            <button class="continue-button" onclick="startTestQuestions()" disabled>
                Почати тестування 🚀
            </button>
        </div>

        <!-- Екран тесту -->
        <div id="test-screen" class="screen hidden">
            <div class="progress-bar">
                <div id="progressFill" class="progress-fill"></div>
            </div>
            <div id="progressText" class="progress-text"></div>

            <div class="block-header">
                <h2 id="blockTitle"></h2>
                <p id="blockDescription"></p>
            </div>

            <div id="questionsContainer"></div>

            <button id="nextButton" class="continue-button" onclick="nextBlockWithProcessing()" disabled>
                Далі ➡️
            </button>
        </div>

        <!-- Екран результатів -->
        <div id="results-screen" class="screen hidden">
            <div class="header">
                <h2>📊 Результати діагностики</h2>
            </div>

            <div id="userInfoResults" class="user-info"></div>
            <div id="dominantResult"></div>
            <div id="allResults" class="results-container"></div>
            <div id="upgradeSection"></div>

            <button onclick="backToMenu()" class="back-to-menu">
                🏠 Повернутися до меню
            </button>
        </div>
    </div>

    <script>
        // Telegram WebApp ініціалізація
        const tg = window.Telegram?.WebApp;
        if (tg) {
            tg.expand();
            tg.ready();
        }

        // Глобальні змінні
        let currentScreen = 'menu';
        let currentBlock = 0;
        let answers = {};
        let userProfile = {};
        let userTestResults = null;
        let testCompletionDate = null;
        let navigationHistory = [];

        // Блоки здоров'я
        const healthBlocks = {
            serotonin: {
                name: 'Серотонін',
                emoji: '😌',
                title: '😌 СЕРОТОНІН - гормон щастя',
                description: 'рівень серотоніну впливає на настрій, сон та загальне самопочуття',
                type: 'neurotransmitter',
                questions: [
                    { id: 'ser_1', text: 'Чи часто відчуваєте пригніченість або сум без видимих причин?' },
                    { id: 'ser_2', text: 'Чи важко вам заснути або ви прокидаєтесь вночі?' },
                    { id: 'ser_3', text: 'Чи відчуваєте тривогу в повсякденних ситуаціях?' },
                    { id: 'ser_4', text: 'Чи маєте сильну тягу до солодкого або вуглеводів?' },
                    { id: 'ser_5', text: 'Чи втратили інтерес до занять, які раніше приносили задоволення?' }
                ],
                recommendations: [
                    "Триптофан 500-1000 мг перед сном",
                    "Вітамін D3 4000-6000 МО щодня (особливо взимку)",
                    "Магній глицинат 400-600 мг ввечері",
                    "Обмежити кофеїн після 14:00",
                    "Ранкове сонце 15-20 хвилин щодня"
                ]
            },
            dopamine: {
                name: 'Дофамін',
                emoji: '🎯',
                title: '🎯 ДОФАМІН - мотивація та винагорода',
                description: 'дофамін відповідає за мотивацію, енергію та відчуття задоволення',
                type: 'neurotransmitter',
                questions: [
                    { id: 'dop_1', text: 'Чи відчуваєте брак мотивації або енергії для повсякденних завдань?' },
                    { id: 'dop_2', text: 'Чи важко вам зосередитися на роботі або навчанні?' },
                    { id: 'dop_3', text: 'Чи шукаєте постійну стимуляцію (соцмережі, відео, їжа)?' },
                    { id: 'dop_4', text: 'Чи відчуваєте, що втратили здатність радіти простим речам?' },
                    { id: 'dop_5', text: 'Чи часто відкладаєте важливі справи на потім?' }
                ],
                recommendations: [
                    "L-тирозин 500-1000 мг вранці натщесерце",
                    "Фолієва кислота 800 мкг + B12 500 мкг",
                    "Обмеження швидких задоволень (TikTok, солодке)",
                    "Фізичні вправи 20-30 хв щодня",
                    "Холодний душ або контрастні процедури"
                ]
            },
            digestive_system: {
                name: 'Шлунково-кишковий тракт',
                emoji: '🍽️',
                title: '🍽️ ШКТ - "другий мозок"',
                description: 'шлунково-кишковий тракт виробляє 80% серотоніну',
                type: 'system',
                questions: [
                    { id: 'dig_1', text: 'Чи маєте проблеми з травленням (здуття, гази, дискомфорт)?' },
                    { id: 'dig_2', text: 'Чи нерегулярний стілець (запори або діарея)?' },
                    { id: 'dig_3', text: 'Чи відчуваєте печію або кислотність?' },
                    { id: 'dig_4', text: 'Чи маєте пищевую непереносимість або алергії?' },
                    { id: 'dig_5', text: 'Чи часто приймали антибіотики останнім часом?' }
                ],
                recommendations: [
                    "Пробіотики 10-50 млрд КУО",
                    "Ферменти з їжею",
                    "L-глутамін для відновлення слизової",
                    "Виключення глютену на 2-4 тижні",
                    "Їжа по режиму (без перекусів)"
                ]
            },
            rectal_parasites: {
                name: 'Задній прохід та гельмінти',
                emoji: '🧻',
                title: '🧻 ЗАДНІЙ ПРОХІД ТА ГЕЛЬМІНТИ - інтимне здоров\'я',
                description: 'стан заднього проходу та наявність паразитів впливають на загальне здоров\'я',
                type: 'medical',
                questions: [
                    { 
                        id: 'rec_1', 
                        text: 'Чи проводите ви час із телефоном у руках, сидячи в туалеті?',
                        type: 'multiple_choice',
                        options: [
                            { text: 'Так', score: 0 },
                            { text: 'Інколи', score: 1 },
                            { text: 'Ні', score: 2 }
                        ]
                    },
                    { 
                        id: 'rec_2', 
                        text: 'Чи доводиться вам тужитись перед початком дефекації?',
                        type: 'multiple_choice',
                        options: [
                            { text: 'Часто', score: 0 },
                            { text: 'Інколи', score: 1 },
                            { text: 'Ні', score: 2 }
                        ]
                    },
                    { id: 'rec_3', text: 'Чи відчуваєте ви біль у ділянці заднього проходу у звичайному житті або при ходьбі?' },
                    { id: 'rec_4', text: 'Чи є у вас біль під час або після дефекації?' },
                    { id: 'rec_5', text: 'Чи маєте ви домашніх тварин?' },
                    { id: 'rec_6', text: 'Чи контактуєте з вуличними тваринами (гладите, підгодовуєте)?' },
                    { id: 'rec_7', text: 'Чи миєте ви овочі та фрукти перед споживанням?' },
                    { id: 'rec_8', text: 'Чи протираєте ви свій телефон антисептиком або вологими серветками хоча б раз на добу?' }
                ],
                recommendations: [
                    "Перейти з туалетного паперу на біде з прохолодною водою",
                    "Консультація проктолога при болях",
                    "Спеціальні вправи тазом (типу Кегеля)",
                    "Курс протипаразитарної програми: масло гарбузового насіння",
                    "Дезінфекція телефону щовечора"
                ]
            },
            activity: {
                name: 'Рівень щоденної активності',
                emoji: '🚶‍♂️',
                title: '🚶‍♂️ АКТИВНІСТЬ - рух це життя',
                description: 'фізична активність впливає на всі системи організму',
                type: 'lifestyle',
                questions: [
                    { 
                        id: 'act_1', 
                        text: 'Скільки ви зазвичай проходите кроків на день?',
                        type: 'multiple_choice',
                        options: [
                            { text: 'Менше 1 000 кроків (сидячий спосіб життя)', score: 0 },
                            { text: 'Від 1 000 до 5 000 кроків (легка активність)', score: 1 },
                            { text: 'Від 5 000 до 10 000 і більше (активний спосіб життя)', score: 2 }
                        ]
                    },
                    { 
                        id: 'act_2', 
                        text: 'Скільки годин на день ви проводите в сидячому положенні?',
                        type: 'multiple_choice',
                        options: [
                            { text: '2-4 години (норма)', score: 2 },
                            { text: '5-7 годин (середньо)', score: 1 },
                            { text: '8+ годин (критично)', score: 0 }
                        ]
                    },
                    { id: 'act_3', text: 'Чи займаєтесь ви регулярними фізичними вправами?' },
                    { id: 'act_4', text: 'Чи відчуваєте ви задишку при підйомі на 2-3 поверх?' },
                    { id: 'act_5', text: 'Чи користуєтесь ви ліфтом замість сходів?' }
                ],
                recommendations: [
                    "Мінімум 8 000 кроків/день для оптимального здоров'я",
                    "Перерви кожні 45 хвилин при сидячій роботі",
                    "Силові тренування 2–3 рази на тиждень",
                    "Активна ходьба/легкий біг — 3–4 рази на тиждень",
                    "При тривалому сидінні: ризик простатиту, геморою, ↓тестостерон"
                ]
            },
            nutrition: {
                name: 'Базове харчування',
                emoji: '🍎',
                title: '🍎 ХАРЧУВАННЯ - основа здоров\'я',
                description: 'якість харчування визначає енергію, настрій та довголіття',
                type: 'lifestyle',
                questions: [
                    { 
                        id: 'nut_1', 
                        text: 'Як часто ви споживаєте білок (м\'ясо, яйця, молочка, риба)?',
                        type: 'multiple_choice',
                        options: [
                            { text: 'Декілька разів на день (м\'ясо, яйця, молочка, риба)', score: 2 },
                            { text: '1 раз на день', score: 1 },
                            { text: 'Рідко (менше 4 разів на тиждень)', score: 0 }
                        ]
                    },
                    { 
                        id: 'nut_3', 
                        text: 'Як часто ви їсте солодке / доданий цукор (печиво, цукерки, десерти)?',
                        type: 'multiple_choice',
                        options: [
                            { text: 'Не їм', score: 2 },
                            { text: 'Інколи', score: 1 },
                            { text: 'Щодня / кілька разів на день', score: 0 }
                        ]
                    }
                ],
                recommendations: [
                    "Білок: 1,2–2 г на 1 кг маси тіла",
                    "Цукрозамінники: стевія, еритрит, але краще перейти на мед",
                    "Сніданок: білок + корисні жири → стабілізація інсуліну зранку",
                    "Питна вода: мінімум 30 мл / кг маси тіла"
                ]
            },
            chronic: {
                name: 'Хронічні хвороби',
                emoji: '🏥',
                title: '🏥 ХРОНІЧНІ ЗАХВОРЮВАННЯ - вплив на загальне здоров\'я',
                description: 'наявність хронічних захворювань впливає на всі системи організму',
                type: 'medical',
                questions: [
                    { 
                        id: 'chr_1', 
                        text: 'Чи є у вас діагностовані хронічні захворювання?',
                        type: 'multiple_select',
                        options: [
                            { text: 'Простатит / проблеми з простатою', value: 'prostatitis' },
                            { text: 'Хронічний тонзиліт / часті ангіни', value: 'tonsillitis' },
                            { text: 'Хронічні утруднення дихання / астма', value: 'breathing' },
                            { text: 'Грижі, протрузії хребта', value: 'spine' },
                            { text: 'Артрити, артрози суглобів', value: 'joints' },
                            { text: 'Печінка (гепатоз, гепатит, синдром Жільбера)', value: 'liver' },
                            { text: 'Нирки / сечовидільна система (цистит, пієлонефрит)', value: 'kidneys' },
                            { text: 'Серцево-судинна система (гіпертонія, аритмія, ішемія)', value: 'cardio' },
                            { text: 'Аутоімунні захворювання (тиреоїдит, псоріаз)', value: 'autoimmune' },
                            { text: 'ШКТ (хронічний гастрит, коліт, Хелікобактер)', value: 'git' },
                            { text: 'Немає хронічних захворювань', value: 'none' }
                        ]
                    }
                ],
                recommendations: [
                    "При простатиті: тиква насіння, цинк, лікарський масаж простати",
                    "При тонзиліті: імуномодулятори курсами, санація вогнищ інфекції",
                    "При проблемах дихання: консультація пульмонолога, спірометрія",
                    "При грижах: ЛФК для хребта, плавання, уникання важких навантажень",
                    "При артрозах: хондропротектори, помірна активність, контроль ваги"
                ]
            }
        };

        // Додаткові питання для кожного блоку
        const extraQuestions = {
            rectal_parasites: [
                { id: 'rec_extra_1', text: 'Чи буває біль у задньому проході при підйомі важких предметів?' },
                { id: 'rec_extra_2', text: 'Чи є у вас свербіж у задньому проході, особливо ввечері або вночі?' },
                { id: 'rec_extra_3', text: 'Чи помічаєте кров під час походу в туалет?' },
                { id: 'rec_extra_4', text: 'Чи складно контролювати гази або стілець?' },
                { id: 'rec_extra_5', text: 'Чи відчуваєте постійне відчуття неповного спорожнення?' }
            ]
        };

        // Продающі тексти для кожної системи
        const systemSellingTexts = {
            serotonin: {
                title: "😌 Серотонін - твоє щастя під контролем",
                text: "Серотонін дає нам звичайний рівень радості, впливає на ментальне самопочуття, щастя і задоволення від життя. Не кради в себе щастя! При низькому серотоніні швидко відбувається акт еякуляції під час сексу. Підйомом серотоніну можна продовжити тривалість статевого акту.",
                practices: ["Не читай погані новини", "Не дивись UFC/бокс надто часто", "Більше сонця та вітаміну D3", "Триптофан з їжі"]
            },
            dopamine: {
                title: "🎯 Дофамін - твій внутрішній двигун",
                text: "Дофамін - це те, що нас запалює! Він понижає пролактин, підвищує сексуальне бажання. Успіх в житті напряму залежить від рівня дофаміну. Це мотивація, драйв та здатність досягати цілей.",
                practices: ["Ставити та досягати маленькі цілі", "Займатись спортом", "Обмежити швидкі задоволення", "Здорова конкуренція"]
            },
            digestive_system: {
                title: "🍽️ ШКТ - твій другий мозок",
                text: "80% серотоніну виробляється в кишечнику! ШКТ - це наш другий мозок, який контролює настрій, імунітет та загальне самопочуття.",
                practices: ["Пробіотики", "Клітковина щодня", "Відмова від солодкого", "Якісна вода"]
            },
            rectal_parasites: {
                title: "🧻 Задній прохід та паразити - інтимне здоров'я",
                text: "Здоров'я заднього проходу та відсутність паразитів критично важливі для якості життя. Часте сидіння з телефоном → застій крові → геморой. Паразити → погане засвоєння поживних речовин → виснаження.",
                practices: ["Біде замість туалетного паперу", "Обмеження часу в туалеті", "Регулярна дегельмінтизація", "Гігієна рук та телефону"]
            }
        };

        // Дієти
        const dietPlans = {
            muscleBuild: {
                title: '🏋️‍♂️ Дієта для набору м\'язової маси',
                description: 'Оптимальне харчування для максимального росту м\'язів',
                target: 'Молоді чоловіки до 35 років, активні спортсмени',
                tags: ['Набір маси', 'Спорт', 'Чоловіки']
            },
            men35Plus: {
                title: '👨‍🦳 Раціон для чоловіків 35+',
                description: 'Збалансоване харчування для підтримки здоров\'я та форми після 35',
                target: 'Чоловіки 35+ років, офісні працівники, помірна активність',
                tags: ['35+', 'Здоров\'я', 'Баланс']
            },
            cutting: {
                title: '🔥 Раціон для "сушки" / рекомпозиції тіла',
                description: 'Спалювання жиру при збереженні м\'язової маси',
                target: 'Для зниження % жиру, покращення рельєфу',
                tags: ['Схуднення', 'Рельєф', 'Сушка']
            },
            womenDaily: {
                title: '👩 Жіночий щоденний раціон',
                description: 'Збалансоване харчування для жінок',
                target: 'Жінки, підтримка форми, гормональний баланс',
                tags: ['Жінки', 'Баланс', 'Здоров\'я']
            },
            womenGain: {
                title: '📈 Жіноча дієта для набору ваги',
                description: 'Здоровий набір маси для жінок',
                target: 'Жінки з дефіцитом ваги',
                tags: ['Жінки', 'Набір ваги', 'Здоров\'я']
            }
        };

        // Курси фармакології
        const pharmaCourses = {
            basic: {
                title: '💊 Базовий курс добавок',
                description: 'Основні вітаміни та мінерали для підтримки здоров\'я',
                duration: '30 днів',
                supplements: [
                    'Мультивітамінний комплекс',
                    'Омега-3 (EPA/DHA)',
                    'Вітамін D3 + K2',
                    'Магній глицинат',
                    'Пробіотики'
                ],
                price: '899 грн'
            },
            energy: {
                title: '⚡ Курс для енергії та мотивації',
                description: 'Підвищення рівня енергії та покращення когнітивних функцій',
                duration: '45 днів',
                supplements: [
                    'Коензим Q10',
                    'L-тирозин',
                    'Родіола рожева',
                    'Комплекс B-вітамінів',
                    'Альфа-ліпоєва кислота'
                ],
                price: '1299 грн'
            },
            hormone: {
                title: '💪 Гормональний баланс',
                description: 'Підтримка здорової гормональної системи',
                duration: '60 днів',
                supplements: [
                    'Цинк хелат',
                    'Ашваганда',
                    'DIM (дііндолілметан)',
                    'Бор',
                    'Фосфатидилсерин'
                ],
                price: '1599 грн'
            },
            detox: {
                title: '🧹 Детокс та очищення',
                description: 'Очищення організму та підтримка печінки',
                duration: '30 днів',
                supplements: [
                    'NAC (N-ацетилцистеїн)',
                    'Розторопша',
                    'Глутатіон',
                    'Хлорела',
                    'Активоване вугілля'
                ],
                price: '1199 грн'
            }
        };

        // Функції навігації
        function goBack() {
            if (navigationHistory.length > 0) {
                const previousScreen = navigationHistory.pop();
                showScreen(previousScreen, false);
            } else {
                showScreen('menu-screen', false);
            }
        }

        function showScreen(screenId, addToHistory = true) {
            if (addToHistory && currentScreen !== 'menu') {
                navigationHistory.push(currentScreen + '-screen');
            }
            
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.add('hidden');
            });
            
            const targetScreen = document.getElementById(screenId);
            if (targetScreen) {
                targetScreen.classList.remove('hidden');
            }
            
            currentScreen = screenId.replace('-screen', '');
            
            // Показати/сховати кнопку назад
            const backButton = document.getElementById('backButton');
            if (currentScreen === 'menu') {
                backButton.classList.add('hidden');
            } else {
                backButton.classList.remove('hidden');
            }
            
            setTimeout(() => scrollToTop(false), 100);
        }

        function scrollToTop(smooth = true) {
            if (smooth) {
                window.scrollTo({
                    top: 0,
                    behavior: 'smooth'
                });
            } else {
                window.scrollTo(0, 0);
            }
        }

        function handleMenuClick(menuId) {
            switch(menuId) {
                case 'test':
                    if (hasCompletedTest() && !canRetakeTest()) {
                        showRetakeWarning();
                    } else {
                        startTest();
                    }
                    break;
                case 'cabinet':
                    if (hasCompletedTest()) {
                        showMyCabinet();
                    } else {
                        alert('Спочатку пройдіть тест для створення особистого кабінету!');
                    }
                    break;
                case 'diet':
                    showDietSection();
                    break;
                case 'pharma':
                    showPharmaSection();
                    break;
                case 'consultation':
                    showConsultationSection();
                    break;
                case 'interpretation':
                    showInterpretationSection();
                    break;
                default:
                    showComingSoon(menuId);
            }
        }

        function startTest() {
            showScreen('profile-screen');
        }

        function startTestQuestions() {
            userProfile = {
                name: document.getElementById('userName').value,
                age: document.getElementById('userAge').value,
                gender: document.getElementById('userGender').value,
                bodyType: document.getElementById('userBodyType').value,
                height: document.getElementById('userHeight').value,
                weight: document.getElementById('userWeight').value
            };

            if (!userProfile.name || !userProfile.age || !userProfile.gender || 
                !userProfile.bodyType || !userProfile.height || !userProfile.weight) {
                alert('Будь ласка, заповніть всі поля!');
                return;
            }

            currentBlock = 0;
            answers = {};
            showScreen('test-screen');
            showTestBlock();
        }

        function getAvailableBlocks() {
            const blocks = [];
            
            Object.entries(healthBlocks).forEach(([key, block]) => {
                if (block.genderSpecific) {
                    if (block.genderSpecific === userProfile.gender) {
                        blocks.push([key, block]);
                    }
                } else {
                    blocks.push([key, block]);
                }
            });
            
            return blocks;
        }

        function showTestBlock() {
            const availableBlocks = getAvailableBlocks();
            
            if (currentBlock >= availableBlocks.length) {
                showResults();
                return;
            }

            const [blockKey, blockData] = availableBlocks[currentBlock];
            
            const isExtraQuestions = answers[`${blockKey}_needs_extra`];
            let currentQuestions;
            
            if (isExtraQuestions && extraQuestions[blockKey]) {
                currentQuestions = extraQuestions[blockKey];
            } else {
                currentQuestions = blockData.questions;
            }
            
            const progress = ((currentBlock + 1) / availableBlocks.length) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
            document.getElementById('progressText').textContent = `📍 Прогрес: ${currentBlock + 1}/${availableBlocks.length}`;
            
            const titleSuffix = isExtraQuestions ? ' (Детальний аналіз)' : '';
            document.getElementById('blockTitle').textContent = blockData.title + titleSuffix;
            document.getElementById('blockDescription').textContent = blockData.description;
            
            const filteredQuestions = currentQuestions.filter(q => 
                !q.genderSpecific || q.genderSpecific === userProfile.gender
            );
            
            const questionsContainer = document.getElementById('questionsContainer');
            questionsContainer.innerHTML = '';
            
            filteredQuestions.forEach((question, index) => {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'question-block';
                
                let optionsHTML = '';
                
                if (question.type === 'multiple_choice') {
                    optionsHTML = question.options.map(option => `
                        <button class="answer-button" onclick="selectAnswer('${question.id}', ${option.score})" 
                                data-question="${question.id}" data-value="${option.score}">
                            ${option.text}
                        </button>
                    `).join('');
                } else if (question.type === 'multiple_select') {
                    optionsHTML = question.options.map(option => `
                        <label class="checkbox-option">
                            <input type="checkbox" value="${option.value}" 
                                   onchange="handleMultipleSelect('${question.id}', '${option.value}', this.checked)">
                            <span>${option.text}</span>
                        </label>
                    `).join('');
                } else {
                    optionsHTML = `
                        <button class="answer-button" onclick="selectAnswer('${question.id}', 0)" 
                                data-question="${question.id}" data-value="0">Так</button>
                        <button class="answer-button" onclick="selectAnswer('${question.id}', 1)" 
                                data-question="${question.id}" data-value="1">Інколи</button>
                        <button class="answer-button" onclick="selectAnswer('${question.id}', 2)" 
                                data-question="${question.id}" data-value="2">Ні</button>
                    `;
                }
                
                questionDiv.innerHTML = `
                    <div class="question-counter">Питання ${index + 1}/${filteredQuestions.length}</div>
                    <p class="question-text">${question.text}</p>
                    <div class="answer-options">${optionsHTML}</div>
                `;
                questionsContainer.appendChild(questionDiv);
            });
            
            const nextButton = document.getElementById('nextButton');
            nextButton.textContent = currentBlock === availableBlocks.length - 1 ? 'Завершити тест 🎯' : 'Далі ➡️';
            nextButton.disabled = true;
            
            checkAllAnswered();
        }

        function selectAnswer(questionId, value) {
            answers[questionId] = value;
            
            const buttons = document.querySelectorAll(`[data-question="${questionId}"]`);
            buttons.forEach(btn => btn.classList.remove('selected'));
            
            const selectedButton = document.querySelector(`[data-question="${questionId}"][data-value="${value}"]`);
            if (selectedButton) {
                selectedButton.classList.add('selected');
            }
            
            checkAllAnswered();
        }

        function handleMultipleSelect(questionId, value, checked) {
            if (!answers[questionId]) {
                answers[questionId] = [];
            }
            
            if (value === 'none') {
                answers[questionId] = checked ? ['none'] : [];
                const otherCheckboxes = document.querySelectorAll(`input[type="checkbox"]:not([value="none"])`);
                otherCheckboxes.forEach(cb => cb.checked = false);
            } else {
                if (checked) {
                    answers[questionId] = answers[questionId].filter(v => v !== 'none').concat(value);
                } else {
                    answers[questionId] = answers[questionId].filter(v => v !== value);
                }
                const noneCheckbox = document.querySelector(`input[value="none"]`);
                if (noneCheckbox) noneCheckbox.checked = false;
            }
            
            checkAllAnswered();
        }

        function checkAllAnswered() {
            const availableBlocks = getAvailableBlocks();
            const [blockKey, blockData] = availableBlocks[currentBlock];
            
            const isExtraQuestions = answers[`${blockKey}_needs_extra`];
            let currentQuestions;
            
            if (isExtraQuestions && extraQuestions[blockKey]) {
                currentQuestions = extraQuestions[blockKey];
            } else {
                currentQuestions = blockData.questions;
            }
            
            const filteredQuestions = currentQuestions.filter(q => 
                !q.genderSpecific || q.genderSpecific === userProfile.gender
            );
            
            const allAnswered = filteredQuestions.every(q => {
                if (q.type === 'multiple_select') {
                    return answers[q.id] && answers[q.id].length > 0;
                }
                return answers[q.id] !== undefined;
            });
            
            document.getElementById('nextButton').disabled = !allAnswered;
        }

        function needsExtraQuestions(blockKey, currentScore) {
            if (blockKey === 'activity') {
                return currentScore <= 3;
            }
            
            const threshold = 5;
            return currentScore <= threshold;
        }

        function checkForAdditionalQuestions(blockKey) {
            const blockData = healthBlocks[blockKey];
            let currentScore = 0;
            
            blockData.questions.forEach(q => {
                if (answers[q.id] !== undefined) {
                    currentScore += answers[q.id];
                }
            });
            
            if (needsExtraQuestions(blockKey, currentScore) && extraQuestions[blockKey] && !answers[`${blockKey}_needs_extra`]) {
                answers[`${blockKey}_needs_extra`] = true;
                
                showProcessingMessage("Виявлено можливий дисбаланс. Потрібен детальніший аналіз...", 2000);
                
                setTimeout(() => {
                    showTestBlock();
                }, 2500);
                
                return true;
            }
            
            return false;
        }

        function showProcessingMessage(message, duration = 2000) {
            return new Promise((resolve) => {
                scrollToTop();
                
                const overlay = document.createElement('div');
                overlay.className = 'processing-overlay';
                overlay.innerHTML = `
                    <div class="processing-card">
                        <div class="processing-spinner"></div>
                        <p class="processing-text">${message}</p>
                        <div class="processing-dots">
                            <span></span><span></span><span></span>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(overlay);
                
                setTimeout(() => {
                    overlay.classList.add('visible');
                }, 100);
                
                setTimeout(() => {
                    overlay.classList.remove('visible');
                    setTimeout(() => {
                        if (overlay.parentNode) {
                            overlay.parentNode.removeChild(overlay);
                        }
                        resolve();
                    }, 300);
                }, duration);
            });
        }

        function showMultipleProcessingMessages(messages, baseDuration = 800) {
            return new Promise(async (resolve) => {
                for (let i = 0; i < messages.length; i++) {
                    const duration = baseDuration + Math.random() * 400;
                    await showProcessingMessage(messages[i], duration);
                    
                    if (i < messages.length - 1) {
                        await new Promise(r => setTimeout(r, 150));
                    }
                }
                resolve();
            });
        }

        async function nextBlockWithProcessing() {
            const availableBlocks = getAvailableBlocks();
            const [currentBlockKey, currentBlockData] = availableBlocks[currentBlock];
            
            scrollToTop();
            
            const needsExtra = checkForAdditionalQuestions(currentBlockKey);
            if (needsExtra) {
                return;
            }
            
            const processingMsgs = ['🧠 Аналізую відповіді...', '📊 Обробляю дані...'];
            await showMultipleProcessingMessages(processingMsgs);
            
            currentBlock++;
            
            if (currentBlock >= availableBlocks.length) {
                const finalMessages = ['📊 Завершую аналіз...', '🎯 Формую результати...'];
                await showMultipleProcessingMessages(finalMessages, 1000);
                showResults();
            } else {
                showTestBlock();
                setTimeout(() => scrollToTop(), 300);
            }
        }

        function showResults() {
            showScreen('results-screen');
            scrollToTop(false);
            calculateAndDisplayResults();
        }

        function calculateAndDisplayResults() {
            const results = {};
            const availableBlocks = getAvailableBlocks();
            
            availableBlocks.forEach(([key, data]) => {
                let score = 0;
                let maxScore = 0;
                
                const isExtraQuestions = answers[`${key}_needs_extra`];
                let allQuestions = data.questions;
                
                if (isExtraQuestions && extraQuestions[key]) {
                    allQuestions = [...data.questions, ...extraQuestions[key]];
                }
                
                const filteredQuestions = allQuestions.filter(q => 
                    !q.genderSpecific || q.genderSpecific === userProfile.gender
                );
                
                filteredQuestions.forEach(q => {
                    if (q.type === 'multiple_select') {
                        maxScore += 2;
                        const selectedValues = answers[q.id] || [];
                        score += (selectedValues.length === 0 || selectedValues.includes('none')) ? 2 : 0;
                    } else {
                        maxScore += 2;
                        score += answers[q.id] || 0;
                    }
                });
                
                const percentage = Math.round((score / maxScore) * 100);
                
                results[key] = {
                    score,
                    maxScore,
                    percentage: Math.min(percentage, 85),
                    ...data
                };
            });

            const bmi = userProfile.weight && userProfile.height 
                ? (userProfile.weight / Math.pow(userProfile.height / 100, 2)).toFixed(1)
                : null;

            const userInfoHTML = `
                <h3>👤 ${userProfile.name}</h3>
                <p>Вік: ${userProfile.age} | Стать: ${userProfile.gender === 'male' ? 'Чоловік' : 'Жінка'}</p>
                ${bmi ? `<p>ІМТ: ${bmi} (${getBMICategory(bmi)})</p>` : ''}
            `;
            document.getElementById('userInfoResults').innerHTML = userInfoHTML;

            let allResultsHTML = '<h3>📊 Детальні результати:</h3>';
            
            Object.entries(results).forEach(([key, result]) => {
                const status = getStatusColor(result.percentage);
                allResultsHTML += `
                    <div class="result-item">
                        <div class="result-header">
                            <span class="result-name">${result.emoji} ${result.name}</span>
                            <span class="result-percentage ${status}">${Math.round(result.percentage)}%</span>
                        </div>
                        <div class="score-bar-small">
                            <div class="score-fill ${status}" style="width: ${result.percentage}%"></div>
                        </div>
                        ${result.percentage < 75 ? `
                        <div class="selling-text">
                            ${getSystemSellingText(key) ? `
                                <h5>${getSystemSellingText(key).title}</h5>
                                <p>${getSystemSellingText(key).text}</p>
                                <div class="basic-practices">
                                    <strong>📋 Базові практики:</strong>
                                    <ul>
                                        ${getSystemSellingText(key).practices.map(practice => `<li>${practice}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                            <div class="upgrade-cta">
                                <p><strong>💎 Список аналізів і стеки добавок, підібрані для вас на основі АІ агента, чекають в розширеній версії</strong></p>
                                <button onclick="showUpgradeOffer()" class="details-btn upgrade-cta-btn">
                                    Детальніше про ${result.name}
                                </button>
                            </div>
                        </div>
                        ` : ''}
                    </div>
                `;
            });

            document.getElementById('allResults').innerHTML = allResultsHTML;
            
            // Зберігаємо результати
            saveTestResults(userProfile, answers, results, []);
        }

        function getBMICategory(bmi) {
            if (bmi < 18.5) return 'Недостатня вага';
            if (bmi < 25) return 'Нормальна вага';
            if (bmi < 30) return 'Надмірна вага';
            return 'Ожиріння';
        }

        function getStatusColor(percentage) {
            if (percentage >= 75) return 'good';
            if (percentage >= 50) return 'warning';
            return 'danger';
        }

        function getSystemSellingText(systemKey) {
            return systemSellingTexts[systemKey] || null;
        }

        // Клас для збереження результатів
        class TestResults {
            constructor(userProfile, answers, results, warnings) {
                this.id = Date.now().toString();
                this.completionDate = new Date().toISOString();
                this.userProfile = { ...userProfile };
                this.answers = { ...answers };
                this.results = { ...results };
                this.warnings = warnings || [];
            }
        }

        function saveTestResults(userProfile, answers, results, warnings) {
            userTestResults = new TestResults(userProfile, answers, results, warnings);
            testCompletionDate = new Date();
            return userTestResults;
        }

        function hasCompletedTest() {
            return userTestResults !== null;
        }

        function canRetakeTest() {
            if (!testCompletionDate) return true;
            const daysSinceTest = (Date.now() - testCompletionDate.getTime()) / (1000 * 60 * 60 * 24);
            return daysSinceTest >= 30;
        }

        function showRetakeWarning() {
            alert('Ви вже проходили тест менше місяця тому. Наступний тест можна буде пройти пізніше для більш точних результатів.');
        }

        function showMyCabinet() {
            if (!hasCompletedTest()) {
                alert('Спочатку пройдіть тест для створення особистого кабінету!');
                return;
            }
            
            const cabinetHTML = `
                <div class="cabinet-container">
                    <h2>👤 Мій кабінет</h2>
                    <p>Тест пройдено: ${formatDate(userTestResults.completionDate)}</p>
                    <p>Ваші результати збережені та доступні для перегляду.</p>
                    <button onclick="showUpgradeOffer()" class="continue-button">
                        💎 Отримати детальний аналіз
                    </button>
                    <button onclick="backToMenu()" class="back-to-menu">
                        🏠 Повернутися до меню
                    </button>
                </div>
            `;
            
            showCustomScreen(cabinetHTML);
        }

        function formatDate(isoString) {
            const date = new Date(isoString);
            return date.toLocaleDateString('uk-UA');
        }

        function showDietSection() {
            const dietHTML = `
                <div class="diet-section">
                    <h2>🥗 Персональні дієти</h2>
                    
                    <div class="diet-menu">
                        <h3>📋 Доступні дієти:</h3>
                        
                        ${Object.entries(dietPlans).map(([key, diet]) => `
                            <div class="diet-card" onclick="showDietDetails('${key}')">
                                <h4>${diet.title}</h4>
                                <p>${diet.description}</p>
                                <small>Для: ${diet.target}</small>
                                <div class="diet-tags">
                                    ${diet.tags.map(tag => `<span class="diet-tag">${tag}</span>`).join('')}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div class="upgrade-cta">
                        <p>💎 Детальні плани харчування з рецептами доступні в розширеній версії</p>
                        <button onclick="showUpgradeOffer()" class="upgrade-cta-btn">
                            Отримати повні плани дієт
                        </button>
                    </div>
                    
                    <button onclick="backToMenu()" class="back-to-menu">
                        🏠 Повернутися до меню
                    </button>
                </div>
            `;
            
            showCustomScreen(dietHTML);
        }

        function showDietDetails(dietKey) {
            const diet = dietPlans[dietKey];
            if (!diet) return;
            
            alert(`Детальний план дієти "${diet.title}" доступний в розширеній версії.`);
        }

        function showPharmaSection() {
            const pharmaHTML = `
                <div class="pharma-section">
                    <h2>💊💉 Фармакологія та добавки</h2>
                    
                    <div class="course-grid">
                        ${Object.entries(pharmaCourses).map(([key, course]) => `
                            <div class="course-card">
                                <h4>${course.title}</h4>
                                <p>${course.description}</p>
                                <ul>
                                    ${course.supplements.map(supp => `<li>${supp}</li>`).join('')}
                                </ul>
                                <p><strong>Тривалість:</strong> ${course.duration}</p>
                                <div class="course-price">${course.price}</div>
                                <button onclick="orderCourse('${key}')" class="continue-button">
                                    Замовити курс
                                </button>
                            </div>
                        `).join('')}
                    </div>
                    
                    <button onclick="backToMenu()" class="back-to-menu">
                        🏠 Повернутися до меню
                    </button>
                </div>
            `;
            
            showCustomScreen(pharmaHTML);
        }

        function orderCourse(courseKey) {
            const course = pharmaCourses[courseKey];
            const message = `Хочу замовити курс: ${course.title}\nЦіна: ${course.price}`;
            window.open(`https://t.me/vladyslav_kravchukk?text=${encodeURIComponent(message)}`, '_blank');
        }

        function showConsultationSection() {
            const consultationHTML = `
                <div class="consultation-section">
                    <h2>👨‍⚕️ Консультація спеціаліста</h2>
                    
                    <div class="specialist-card">
                        <h3>Владислав Кравчук</h3>
                        <p>Спеціаліст з функціональної медицини</p>
                        
                        <div class="consultation-types">
                            <div class="course-card">
                                <h4>📞 Базова консультація</h4>
                                <ul>
                                    <li>Аналіз результатів тесту</li>
                                    <li>Індивідуальні рекомендації</li>
                                    <li>План обстежень</li>
                                    <li>Тривалість: 45 хвилин</li>
                                </ul>
                                <div class="course-price">799 грн</div>
                            </div>
                            
                            <div class="course-card">
                                <h4>💎 Розширена консультація</h4>
                                <ul>
                                    <li>Детальний аналіз всіх систем</li>
                                    <li>Персональний план на 3 місяці</li>
                                    <li>Підбір добавок з схемами</li>
                                    <li>Супровід протягом місяця</li>
                                    <li>Тривалість: 90 хвилин</li>
                                </ul>
                                <div class="course-price">1299 грн</div>
                            </div>
                        </div>
                        
                        <a href="https://t.me/vladyslav_kravchukk" target="_blank" class="continue-button">
                            📱 Написати в Telegram
                        </a>
                    </div>
                    
                    <button onclick="backToMenu()" class="back-to-menu">
                        🏠 Повернутися до меню
                    </button>
                </div>
            `;
            
            showCustomScreen(consultationHTML);
        }

        function showInterpretationSection() {
            const interpretationHTML = `
                <div class="interpretation-section">
                    <h2>📊 Інтерпретація аналізів</h2>
                    
                    <div class="course-card">
                        <h4>🔬 Аналіз лабораторних показників</h4>
                        <p>Професійна інтерпретація ваших аналізів крові, гормонів та інших біомаркерів</p>
                        <ul>
                            <li>Загальний аналіз крові</li>
                            <li>Біохімічний аналіз</li>
                            <li>Гормональна панель</li>
                            <li>Вітаміни та мінерали</li>
                            <li>Маркери запалення</li>
                        </ul>
                        <div class="course-price">599 грн</div>
                        <p><small>Надішліть фото ваших аналізів, отримайте детальну інтерпретацію протягом 24 годин</small></p>
                    </div>
                    
                    <a href="https://t.me/vladyslav_kravchukk?text=Хочу замовити інтерпретацію аналізів" 
                       target="_blank" class="continue-button">
                        📱 Замовити інтерпретацію
                    </a>
                    
                    <button onclick="backToMenu()" class="back-to-menu">
                        🏠 Повернутися до меню
                    </button>
                </div>
            `;
            
            showCustomScreen(interpretationHTML);
        }

        function showUpgradeOffer() {
            const upgradeHTML = `
                <div class="upgrade-offer">
                    <h2>🚀 Розширена версія PantelMed AI</h2>
                    
                    <div class="course-card">
                        <h4>💎 Повний пакет</h4>
                        <ul>
                            <li>Персональні стеки добавок</li>
                            <li>Детальні схеми прийому</li>
                            <li>Вилки взаємодії систем</li>
                            <li>Консультація спеціаліста</li>
                            <li>Моніторинг прогресу</li>
                        </ul>
                        <div class="course-price">1299 грн</div>
                    </div>
                    
                    <a href="https://t.me/vladyslav_kravchukk?text=Хочу замовити розширену версію PantelMed AI" 
                       target="_blank" class="continue-button">
                        💳 Замовити розширену версію
                    </a>
                    
                    <button onclick="backToMenu()" class="continue-button secondary">
                        ← Повернутися до безкоштовної версії
                    </button>
                </div>
            `;
            
            showCustomScreen(upgradeHTML);
        }

        function showCustomScreen(htmlContent) {
            let customScreen = document.getElementById('custom-screen');
            if (!customScreen) {
                customScreen = document.createElement('div');
                customScreen.id = 'custom-screen';
                customScreen.className = 'screen hidden';
                document.querySelector('.app').appendChild(customScreen);
            }
            
            customScreen.innerHTML = htmlContent;
            showScreen('custom-screen');
        }

        function showComingSoon(featureName) {
            const comingSoonHTML = `
                <div class="coming-soon-section">
                    <h2>🚧 ${featureName}</h2>
                    <div class="coming-soon-content">
                        <div class="construction-icon">⚙️</div>
                        <h3>Розділ в розробці</h3>
                        <p>Ми працюємо над цією функцією. Незабаром вона буде доступна!</p>
                        
                        <a href="https://t.me/vladyslav_kravchukk" target="_blank" class="continue-button">
                            🔔 Підписатися на оновлення
                        </a>
                    </div>
                    
                    <button onclick="backToMenu()" class="back-to-menu">
                        🏠 Повернутися до меню
                    </button>
                </div>
            `;
            
            showCustomScreen(comingSoonHTML);
        }

        function backToMenu() {
            showScreen('menu-screen', false);
            currentBlock = 0;
            answers = {};
        }

        // Ініціалізація при завантаженні
        document.addEventListener('DOMContentLoaded', function() {
            showScreen('menu-screen', false);
            
            if (tg && tg.initDataUnsafe?.user?.first_name) {
                document.getElementById('userName').value = tg.initDataUnsafe.user.first_name;
            }
        });

        // Валідація форми профілю
        document.addEventListener('input', function(e) {
            if (e.target.closest('#profile-screen')) {
                const name = document.getElementById('userName').value;
                const age = document.getElementById('userAge').value;
                const gender = document.getElementById('userGender').value;
                const bodyType = document.getElementById('userBodyType').value;
                const height = document.getElementById('userHeight').value;
                const weight = document.getElementById('userWeight').value;
                
                const allFilled = name && age && gender && bodyType && height && weight;
                document.querySelector('#profile-screen .continue-button').disabled = !allFilled;
            }
        });
    </script>
</body>
</html>
